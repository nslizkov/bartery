<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Пользователи — Обмен навыками</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="nav">
    <a href="users.html">Пользователи</a>
    <a href="me.html">Мой профиль</a>
    <a href="messages.html">Сообщения</a>
    <span class="right"><a href="#" id="logout">Выйти</a></span>
  </nav>
  <div class="container">
    <h1>Пользователи</h1>
    <p>Список всех зарегистрированных пользователей. Нажмите на карточку, чтобы открыть профиль и написать.</p>
    <div id="err" class="alert alert-danger" style="display: none;"></div>
    <div id="list" class="user-grid"></div>
  </div>
  <script src="js/api.js"></script>
  <script>
    if (!api.getToken()) location.replace('login.html');
    document.getElementById('logout').addEventListener('click', (e) => {
      e.preventDefault();
      api.auth.logout().catch(() => {});
      api.setToken(null);
      location.replace('login.html');
    });

    function escapeHtml(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function load() {
      const list = document.getElementById('list');
      const err = document.getElementById('err');
      try {
        const me = await api.users.me();
        const myId = me.user.id;
        const r = await fetch(api.base + '/api/users', { headers: { Authorization: 'Bearer ' + api.getToken() } }).then(res => res.json());
        const users = (r.users || []).filter(u => u.id !== myId);
        list.innerHTML = users.map(u => {
          const name = u.full_name || u.username || 'Без имени';
          const avatar = u.avatar_url ? `<img class="avatar" src="${escapeHtml(u.avatar_url)}" alt="">` : '<div class="avatar"></div>';
          return `<div class="user-card"><a href="profile.html?id=${u.id}">${avatar}<div class="name">${escapeHtml(name)}</div><div class="username">@${escapeHtml(u.username)}</div></a></div>`;
        }).join('') || '<p class="empty">Пока никого нет</p>';
      } catch (x) {
        if (x.status === 401) { api.setToken(null); location.replace('login.html'); return; }
        err.textContent = (x.data && x.data.error) || 'Не удалось загрузить список';
        err.style.display = 'block';
      }
    }
    load();
  </script>
</body>
</html>
