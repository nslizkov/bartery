<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Мой профиль — Обмен навыками</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <nav class="nav">
    <a href="users.html">Пользователи</a>
    <a href="me.html">Мой профиль</a>
    <a href="messages.html">Сообщения</a>
    <span class="right"><a href="#" id="logout">Выйти</a></span>
  </nav>
  <div class="container">
    <div id="err" class="alert alert-danger" style="display: none;"></div>
    <div id="profile" class="card" style="display: none;">
      <div class="profile-header" style="flex-wrap: wrap;">
        <div>
          <img id="profileAvatar" class="profile-avatar" src="" alt="" style="display: none;">
          <div id="profileAvatarPlaceholder" class="profile-avatar"></div>
          <form id="avatarForm" style="margin-top: 0.5rem;">
            <input type="file" name="avatar" accept="image/jpeg,image/png,image/gif,image/webp" id="avatarInput" style="font-size: 14px;">
            <button type="submit" class="btn btn-sm" id="avatarSubmit" disabled>Загрузить</button>
          </form>
        </div>
        <div class="profile-meta" id="profileMeta"></div>
      </div>
    </div>
    <div id="loading">Загрузка…</div>

    <div class="card" id="addSkillCard" style="display: none;">
      <h2>Добавить навык</h2>
      <form id="addSkillForm">
        <div class="form-group">
          <label>Навык</label>
          <select name="skill_id" id="skillSelect" required></select>
        </div>
        <div class="form-group">
          <label>Тип</label>
          <select name="type">
            <option value="teach">Могу научить</option>
            <option value="learn">Хочу научиться</option>
          </select>
        </div>
        <div class="form-group">
          <label>Уровень (1–5)</label>
          <input type="number" name="proficiency_level" min="1" max="5" value="1">
        </div>
        <div class="form-group">
          <label>Комментарий (необязательно)</label>
          <textarea name="description" placeholder="Например: базовый уровень, могу объяснить основы"></textarea>
        </div>
        <button type="submit" class="btn">Добавить</button>
      </form>
    </div>

    <div class="card" id="mySkillsCard" style="display: none;">
      <h2>Мои навыки</h2>
      <ul class="skills-list" id="mySkillsList"></ul>
      <p class="empty" id="noSkills" style="display: none;">Пока нет добавленных навыков.</p>
    </div>
  </div>
  <script src="js/api.js"></script>
  <script>
    if (!api.getToken()) location.replace('login.html');
    document.getElementById('logout').addEventListener('click', (e) => {
      e.preventDefault();
      api.auth.logout().catch(() => {});
      api.setToken(null);
      location.replace('login.html');
    });

    function escapeHtml(s) {
      if (s == null) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    const err = document.getElementById('err');
    const loading = document.getElementById('loading');
    const profileEl = document.getElementById('profile');
    const addSkillCard = document.getElementById('addSkillCard');
    const addSkillForm = document.getElementById('addSkillForm');
    const skillSelect = document.getElementById('skillSelect');
    const mySkillsCard = document.getElementById('mySkillsCard');
    const mySkillsList = document.getElementById('mySkillsList');
    const noSkills = document.getElementById('noSkills');

    function showAvatar(url) {
      const img = document.getElementById('profileAvatar');
      const pl = document.getElementById('profileAvatarPlaceholder');
      if (url) {
        img.src = url;
        img.style.display = 'block';
        pl.style.display = 'none';
      } else {
        img.style.display = 'none';
        pl.style.display = 'block';
      }
    }

    async function loadProfile() {
      try {
        const r = await api.users.me();
        const u = r.user;
        const name = u.full_name || u.username || 'Без имени';
        document.getElementById('profileMeta').innerHTML = `
          <h2>${escapeHtml(name)}</h2>
          <p style="color:#666">@${escapeHtml(u.username)} · ${escapeHtml(u.email)}</p>
          ${u.bio ? '<p>' + escapeHtml(u.bio) + '</p>' : ''}
          <p>Очков: ${Number(u.points) || 0}</p>
        `;
        showAvatar(u.avatar_url || null);
        loading.style.display = 'none';
        profileEl.style.display = 'block';
        addSkillCard.style.display = 'block';
        mySkillsCard.style.display = 'block';
        loadSkillsSelect();
        loadMySkills();
      } catch (x) {
        if (x.status === 401) { api.setToken(null); location.replace('login.html'); return; }
        loading.style.display = 'none';
        err.textContent = (x.data && x.data.error) || 'Ошибка загрузки';
        err.style.display = 'block';
      }
    }

    async function loadSkillsSelect() {
      try {
        const r = await api.skills();
        const skills = r.skills || [];
        skillSelect.innerHTML = '<option value="">— выбрать —</option>' + skills.map(s => 
          '<option value="' + s.id + '">' + escapeHtml(s.name) + (s.category_name ? ' (' + escapeHtml(s.category_name) + ')' : '') + '</option>'
        ).join('');
      } catch (_) {}
    }

    async function loadMySkills() {
      try {
        const r = await api.users.mySkills();
        const skills = r.skills || [];
        noSkills.style.display = skills.length ? 'none' : 'block';
        mySkillsList.innerHTML = skills.map(s => `
          <li>
            <span><span class="skill-tag ${s.type}">${escapeHtml(s.skill_name)}</span> ${s.type === 'teach' ? 'учу' : 'хочу научиться'} · уровень ${s.proficiency_level || 1}</span>
            <button type="button" class="btn btn-danger btn-sm" data-skill-id="${s.skill_id}">Удалить</button>
          </li>
        `).join('');
        mySkillsList.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('Удалить этот навык?')) return;
            try {
              await api.users.removeSkill(btn.dataset.skillId);
              loadMySkills();
            } catch (x) {
              err.textContent = (x.data && x.data.error) || 'Ошибка';
              err.style.display = 'block';
            }
          });
        });
      } catch (x) {
        noSkills.style.display = 'block';
        mySkillsList.innerHTML = '';
      }
    }

    document.getElementById('avatarInput').addEventListener('change', (e) => {
      document.getElementById('avatarSubmit').disabled = !e.target.files?.length;
    });
    document.getElementById('avatarForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = document.getElementById('avatarInput').files?.[0];
      if (!file) return;
      err.style.display = 'none';
      document.getElementById('avatarSubmit').disabled = true;
      try {
        const r = await api.users.uploadAvatar(file);
        showAvatar(r.avatar_url || r.user?.avatar_url);
        document.getElementById('avatarInput').value = '';
      } catch (x) {
        err.textContent = (x.data && x.data.error) || 'Ошибка загрузки';
        err.style.display = 'block';
        document.getElementById('avatarSubmit').disabled = false;
      }
    });

    addSkillForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.style.display = 'none';
      const fd = new FormData(addSkillForm);
      const skillId = fd.get('skill_id');
      if (!skillId) return;
      try {
        await api.users.addSkill({
          skill_id: parseInt(skillId, 10),
          type: fd.get('type'),
          proficiency_level: parseInt(fd.get('proficiency_level'), 10) || 1,
          description: fd.get('description') || undefined
        });
        addSkillForm.reset();
        skillSelect.value = '';
        loadMySkills();
      } catch (x) {
        err.textContent = (x.data && x.data.error) || 'Не удалось добавить навык';
        err.style.display = 'block';
      }
    });

    loadProfile();
  </script>
</body>
</html>
